# F3.4: Availability Calendar

**Status**: Pending
**Priority**: High (Week 5)

## Purpose

Allow stylists to set their recurring weekly availability and manage date-specific exceptions (blocked days, holidays).

## User Story

As a stylist, I want to set my working hours and block specific dates, so customers only see times when I'm actually available.

## Components

### Page
- `app/dashboard/availability/page.tsx` — Calendar management page

### Components
- `components/dashboard/weekly-schedule.tsx` — 7-day recurring availability grid
- `components/dashboard/time-block-editor.tsx` — Edit hours for a specific day
- `components/dashboard/exception-manager.tsx` — Block/unblock specific dates

## UI Layout

### Weekly Schedule View

```
┌─────────────────────────────────────────────────────────────┐
│  My Availability                                            │
│                                                             │
│  Weekly Schedule                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     MON       TUE       WED       THU       FRI       SAT  │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
│  │ 09:00 │ │ 09:00 │ │ 09:00 │ │ 09:00 │ │ 09:00 │ │ 10:00 │
│  │   -   │ │   -   │ │   -   │ │   -   │ │   -   │ │   -   │
│  │ 18:00 │ │ 18:00 │ │ 18:00 │ │ 18:00 │ │ 17:00 │ │ 14:00 │
│  │       │ │       │ │       │ │       │ │       │ │       │
│  │ [Edit]│ │ [Edit]│ │ [Edit]│ │ [Edit]│ │ [Edit]│ │ [Edit]│
│  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘
│                                                             │
│     SUN                                                     │
│  ┌───────┐                                                  │
│  │ CLOSED│                                                  │
│  │       │                                                  │
│  │ [Edit]│                                                  │
│  └───────┘                                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Blocked Dates                          [+ Block Date]      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Dec 25, 2025 (Christmas)                      [Remove] ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Dec 26, 2025 (Boxing Day)                     [Remove] ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Jan 1, 2026 (New Year's Day)                  [Remove] ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Time Block Editor Dialog

```
┌─────────────────────────────────────────────────┐
│  Edit Monday Hours                          ✕   │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────────┐│
│  │ ☑ Available on Mondays                      ││
│  └─────────────────────────────────────────────┘│
│                                                 │
│  Time Slot 1                                    │
│  Start                      End                 │
│  ┌───────────────────┐      ┌─────────────────┐│
│  │ 09:00           ▼ │      │ 13:00         ▼ ││
│  └───────────────────┘      └─────────────────┘│
│                                                 │
│  Time Slot 2 (optional)                         │
│  Start                      End                 │
│  ┌───────────────────┐      ┌─────────────────┐│
│  │ 14:00           ▼ │      │ 18:00         ▼ ││
│  └───────────────────┘      └─────────────────┘│
│                                                 │
│  [+ Add another time slot]                      │
│                                                 │
│  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Cancel    │  │        Save             │  │
│  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

## Data Model

### Prisma Schema Addition
```prisma
model StylistAvailability {
  id          String   @id @default(uuid())
  stylistId   String   @unique
  stylist     User     @relation(fields: [stylistId], references: [id])
  schedule    Json     // Weekly recurring schedule
  exceptions  Json     // Blocked dates array
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

### Schedule JSON Structure
```typescript
interface WeeklySchedule {
  mon: TimeSlot[];
  tue: TimeSlot[];
  wed: TimeSlot[];
  thu: TimeSlot[];
  fri: TimeSlot[];
  sat: TimeSlot[];
  sun: TimeSlot[];
}

interface TimeSlot {
  start: string;  // "09:00"
  end: string;    // "18:00"
}

// Example
{
  "mon": [{ "start": "09:00", "end": "13:00" }, { "start": "14:00", "end": "18:00" }],
  "tue": [{ "start": "09:00", "end": "18:00" }],
  "wed": [{ "start": "09:00", "end": "18:00" }],
  "thu": [{ "start": "09:00", "end": "18:00" }],
  "fri": [{ "start": "09:00", "end": "17:00" }],
  "sat": [{ "start": "10:00", "end": "14:00" }],
  "sun": []  // Closed
}
```

### Exceptions JSON Structure
```typescript
interface DateException {
  date: string;      // "2025-12-25"
  blocked: boolean;  // true = blocked, false = available override
  note?: string;     // "Christmas"
}

// Example
[
  { "date": "2025-12-25", "blocked": true, "note": "Christmas" },
  { "date": "2025-12-26", "blocked": true, "note": "Boxing Day" }
]
```

## Backend Endpoints

### Get Availability
```
GET /api/stylists/availability
Authorization: Bearer <token>

Response: 200 OK
{
  "schedule": { ... },
  "exceptions": [ ... ]
}
```

### Update Weekly Schedule
```
PUT /api/stylists/availability
Authorization: Bearer <token>

Body:
{
  "schedule": {
    "mon": [{ "start": "09:00", "end": "18:00" }],
    ...
  }
}

Response: 200 OK
{ ...updated availability }
```

### Add Date Exception
```
POST /api/stylists/availability/exceptions
Authorization: Bearer <token>

Body:
{
  "date": "2025-12-25",
  "blocked": true,
  "note": "Christmas"
}

Response: 201 Created
```

### Remove Date Exception
```
DELETE /api/stylists/availability/exceptions/:date
Authorization: Bearer <token>

Response: 204 No Content
```

## Time Slot Validation

| Rule | Description |
|------|-------------|
| No overlap | Time slots cannot overlap on same day |
| Min duration | Each slot must be at least 30 minutes |
| Valid range | Start must be before end |
| Business hours | 06:00 - 23:00 allowed |
| Max slots per day | 4 slots maximum |

## Default Schedule (New Stylists)

```json
{
  "mon": [{ "start": "09:00", "end": "17:00" }],
  "tue": [{ "start": "09:00", "end": "17:00" }],
  "wed": [{ "start": "09:00", "end": "17:00" }],
  "thu": [{ "start": "09:00", "end": "17:00" }],
  "fri": [{ "start": "09:00", "end": "17:00" }],
  "sat": [],
  "sun": []
}
```

## Acceptance Criteria

- [ ] Weekly schedule displays all 7 days
- [ ] Can edit hours for each day
- [ ] Can mark days as closed (empty schedule)
- [ ] Can add multiple time slots per day (e.g., lunch break)
- [ ] Can block specific dates
- [ ] Can add notes to blocked dates
- [ ] Can remove date exceptions
- [ ] Validation prevents invalid time ranges
- [ ] Changes save immediately with optimistic updates
- [ ] Visual feedback shows saved state
- [ ] Empty exceptions list shows helpful message

## Integration Notes

When customers book:
1. Check stylist's weekly schedule for requested day
2. Check if date is in exceptions (blocked)
3. Check if time slot falls within available hours
4. Check no existing confirmed bookings overlap
