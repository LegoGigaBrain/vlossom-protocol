# F2.7: Escrow Payment Flow

## Feature Specification

**Feature ID:** F2.7
**Feature Name:** Escrow Payment Flow
**Milestone:** 2 - Customer Can Book
**Priority:** High
**Status:** Planned
**Depends On:** F2.6

---

## User Story

> As a customer, I want to pay for my booking securely so that my funds are protected until the service is completed.

---

## Acceptance Criteria

1. Customer sees payment step after booking summary
2. USDC approval transaction initiated (if needed)
3. Escrow lock transaction initiated after approval
4. Loading states during blockchain transactions
5. Error handling for failed transactions
6. Success confirmation with booking reference
7. Redirect to booking details on success

---

## Technical Specification

### Smart Contract Integration

The payment flow uses the deployed Escrow contract:

```typescript
// Contract addresses (Base Sepolia)
const ESCROW_ADDRESS = "0x..."; // From deployments
const USDC_ADDRESS = "0x036CbD53842c5426634e7929541eC2318f3dCF7e";

// ABI functions used
interface EscrowContract {
  lockFunds(
    bookingId: string,
    stylistAddress: string,
    amount: bigint,
    serviceFee: bigint
  ): Promise<TransactionReceipt>;
}

interface USDCContract {
  approve(spender: string, amount: bigint): Promise<TransactionReceipt>;
  allowance(owner: string, spender: string): Promise<bigint>;
}
```

---

### Payment Flow Steps

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Booking Summary â”‚
â”‚   "Confirm"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check USDC      â”‚â”€â”€â”€â”€â–¶â”‚ Sufficient      â”‚
â”‚ Allowance       â”‚     â”‚ Allowance?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                   No â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Yes
                   â”‚                          â”‚
                   â–¼                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
         â”‚ Request USDC    â”‚                  â”‚
         â”‚ Approval Tx     â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                  â”‚                           â”‚
                  â–¼                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
         â”‚ Wait for        â”‚                  â”‚
         â”‚ Confirmation    â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                  â”‚                           â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Lock Funds in   â”‚
                                    â”‚ Escrow          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Wait for        â”‚
                                    â”‚ Confirmation    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Update Booking  â”‚
                                    â”‚ Status â†’ PAID   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Show Success    â”‚
                                    â”‚ Navigate        â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Files to Create

| File | Purpose |
|------|---------|
| `apps/web/components/booking/payment-step.tsx` | Payment step UI |
| `apps/web/hooks/use-escrow.ts` | Escrow contract interactions |
| `apps/web/lib/escrow-client.ts` | Escrow API client |

---

### Component: PaymentStep

```tsx
interface PaymentStepProps {
  bookingId: string;
  amount: number;           // Total in cents
  stylistAddress: string;
  onSuccess: () => void;
  onError: (error: Error) => void;
}

type PaymentState =
  | "idle"
  | "checking_allowance"
  | "awaiting_approval"
  | "approving"
  | "locking"
  | "confirming"
  | "success"
  | "error";
```

**Layout:**
```
+----------------------------------+
| Payment                          |
+----------------------------------+
|                                  |
| Total to Pay                     |
| R385.00                          |
|                                  |
+----------------------------------+
| Payment Method                   |
| ðŸ’° USDC Wallet                   |
|    Balance: R500.00              |
+----------------------------------+
|                                  |
| [    Confirm Payment    ]        |
|                                  |
+----------------------------------+

(During approval)
+----------------------------------+
| Approving USDC...                |
|                                  |
| [Loading spinner]                |
|                                  |
| Please confirm in your wallet    |
+----------------------------------+

(During lock)
+----------------------------------+
| Securing Payment...              |
|                                  |
| [Loading spinner]                |
|                                  |
| Locking funds in escrow          |
+----------------------------------+

(Success)
+----------------------------------+
| âœ“ Payment Successful!            |
|                                  |
| Your booking is confirmed.       |
| Booking #VLS-2025-001234         |
|                                  |
| [   View Booking Details   ]     |
+----------------------------------+
```

---

### Hook: useEscrow

```tsx
import { useWriteContract, useWaitForTransaction } from "wagmi";
import { parseUnits } from "viem";

export function useEscrow() {
  const { writeContractAsync: writeUsdc } = useWriteContract();
  const { writeContractAsync: writeEscrow } = useWriteContract();

  const checkAllowance = async (
    ownerAddress: string,
    amount: bigint
  ): Promise<boolean> => {
    // Read current allowance
    const allowance = await readContract({
      address: USDC_ADDRESS,
      abi: ERC20_ABI,
      functionName: "allowance",
      args: [ownerAddress, ESCROW_ADDRESS],
    });
    return allowance >= amount;
  };

  const approveUsdc = async (amount: bigint): Promise<`0x${string}`> => {
    const hash = await writeUsdc({
      address: USDC_ADDRESS,
      abi: ERC20_ABI,
      functionName: "approve",
      args: [ESCROW_ADDRESS, amount],
    });
    return hash;
  };

  const lockFunds = async (
    bookingId: string,
    stylistAddress: string,
    amount: bigint,
    serviceFee: bigint
  ): Promise<`0x${string}`> => {
    const hash = await writeEscrow({
      address: ESCROW_ADDRESS,
      abi: ESCROW_ABI,
      functionName: "lockFunds",
      args: [bookingId, stylistAddress, amount, serviceFee],
    });
    return hash;
  };

  return {
    checkAllowance,
    approveUsdc,
    lockFunds,
  };
}
```

---

### Payment Flow Implementation

```typescript
const handlePayment = async () => {
  try {
    setState("checking_allowance");

    // Convert amount to USDC (6 decimals)
    const amountInUsdc = parseUnits(
      (priceBreakdown.totalAmount / 100).toString(),
      6
    );
    const serviceFeeInUsdc = parseUnits(
      (priceBreakdown.platformFee / 100).toString(),
      6
    );

    // Step 1: Check allowance
    const hasAllowance = await checkAllowance(userAddress, amountInUsdc);

    // Step 2: Approve if needed
    if (!hasAllowance) {
      setState("awaiting_approval");
      const approvalHash = await approveUsdc(amountInUsdc);
      setState("approving");
      await waitForTransaction({ hash: approvalHash });
    }

    // Step 3: Lock funds in escrow
    setState("locking");
    const lockHash = await lockFunds(
      bookingId,
      stylistAddress,
      amountInUsdc,
      serviceFeeInUsdc
    );

    setState("confirming");
    await waitForTransaction({ hash: lockHash });

    // Step 4: Update booking status via API
    await updateBookingStatus(bookingId, "CONFIRMED");

    setState("success");
    onSuccess();

  } catch (error) {
    setState("error");
    onError(error as Error);
  }
};
```

---

### API Integration

```typescript
// After successful escrow lock
async function updateBookingStatus(
  bookingId: string,
  status: "CONFIRMED"
): Promise<void> {
  await fetch(`/api/bookings/${bookingId}/status`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      status,
      escrowTxHash: lockHash,
    }),
  });
}
```

---

## UI/UX Requirements

### Visual Design
- Clear payment amount display
- Wallet balance shown for reference
- Transaction status with spinner
- Success state with checkmark animation
- Error state with retry option

### States
- **Idle:** "Confirm Payment" button active
- **Checking:** Loading, checking allowance
- **Awaiting Approval:** Wallet prompt instructions
- **Approving:** Spinner, "Please wait..."
- **Locking:** Spinner, "Securing payment..."
- **Confirming:** Spinner, "Almost done..."
- **Success:** Checkmark, booking reference
- **Error:** Error message, retry button

### Transaction Messaging

| State | Primary Text | Secondary Text |
|-------|--------------|----------------|
| Awaiting Approval | "Approve USDC" | "Please confirm in your wallet" |
| Approving | "Approving..." | "This may take a moment" |
| Locking | "Securing Payment" | "Locking funds in escrow" |
| Confirming | "Almost Done" | "Confirming transaction" |
| Success | "Payment Successful!" | "Your booking is confirmed" |
| Error | "Payment Failed" | [Error message] |

---

## Error Handling

```typescript
const getErrorMessage = (error: Error): string => {
  if (error.message.includes("user rejected")) {
    return "Transaction cancelled. Please try again.";
  }
  if (error.message.includes("insufficient funds")) {
    return "Insufficient USDC balance. Please add funds.";
  }
  if (error.message.includes("network")) {
    return "Network error. Please check your connection.";
  }
  return "Payment failed. Please try again.";
};
```

---

## Tasks Breakdown

| Task | Effort | Priority |
|------|--------|----------|
| Create `PaymentStep` component | 45min | P0 |
| Create `useEscrow` hook | 45min | P0 |
| Implement allowance check | 20min | P0 |
| Implement USDC approval | 25min | P0 |
| Implement escrow lock | 25min | P0 |
| Add transaction waiting | 20min | P0 |
| Create loading states UI | 30min | P1 |
| Create success state UI | 20min | P1 |
| Add error handling | 25min | P1 |
| Connect to booking API | 15min | P0 |

**Total Estimated Time:** ~4.5 hours

---

## Verification Checklist

- [ ] Payment amount displays correctly
- [ ] Wallet balance shows
- [ ] Allowance check works
- [ ] Approval transaction fires (when needed)
- [ ] Approval transaction confirmed
- [ ] Escrow lock transaction fires
- [ ] Lock transaction confirmed
- [ ] Booking status updated in database
- [ ] Success state displays
- [ ] Booking reference shown
- [ ] Navigate to booking details works
- [ ] User rejection handled gracefully
- [ ] Network errors handled
- [ ] Insufficient balance handled
- [ ] Retry works after error
