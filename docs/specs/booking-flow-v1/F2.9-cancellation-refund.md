# F2.9: Booking Cancellation & Refund

## Feature Specification

**Feature ID:** F2.9
**Feature Name:** Booking Cancellation & Refund
**Milestone:** 2 - Customer Can Book
**Priority:** Medium
**Status:** Planned
**Depends On:** F2.8

---

## User Story

> As a customer, I want to cancel my booking and receive a refund so that I'm not charged for appointments I can't attend.

---

## Acceptance Criteria

1. Cancel button visible on confirmed bookings
2. Cancellation requires confirmation dialog
3. Cancellation policy displayed before confirming
4. Escrow refund initiated on cancellation
5. Booking status updated to CANCELLED
6. Refund amount shown (based on cancellation policy)
7. Success confirmation with refund details
8. Cannot cancel completed or already cancelled bookings

---

## Technical Specification

### Cancellation Policy (MVP)

For MVP, simple time-based policy:

| Time Before Appointment | Refund Amount |
|------------------------|---------------|
| > 24 hours | 100% refund |
| 12-24 hours | 75% refund |
| < 12 hours | 50% refund |
| < 2 hours | No refund |

```typescript
interface CancellationPolicy {
  hoursUntilAppointment: number;
  refundPercentage: number;
  message: string;
}

function getCancellationPolicy(scheduledTime: Date): CancellationPolicy {
  const now = new Date();
  const hoursUntil = (scheduledTime.getTime() - now.getTime()) / (1000 * 60 * 60);

  if (hoursUntil > 24) {
    return {
      hoursUntilAppointment: hoursUntil,
      refundPercentage: 100,
      message: "Full refund - cancelling more than 24 hours before appointment",
    };
  }
  if (hoursUntil > 12) {
    return {
      hoursUntilAppointment: hoursUntil,
      refundPercentage: 75,
      message: "75% refund - cancelling 12-24 hours before appointment",
    };
  }
  if (hoursUntil > 2) {
    return {
      hoursUntilAppointment: hoursUntil,
      refundPercentage: 50,
      message: "50% refund - cancelling less than 12 hours before appointment",
    };
  }
  return {
    hoursUntilAppointment: hoursUntil,
    refundPercentage: 0,
    message: "No refund - cancelling less than 2 hours before appointment",
  };
}
```

---

### Cancellation Flow

```
┌─────────────────┐
│ Booking Details │
│ [Cancel Booking]│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Cancellation    │
│ Dialog          │
│ - Policy shown  │
│ - Refund amount │
│ [Confirm Cancel]│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Call Escrow     │
│ releaseFunds()  │
│ (partial/full)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Wait for        │
│ Confirmation    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Update Booking  │
│ Status → CANCEL │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Success Screen  │
│ - Refund amount │
│ - Wallet balance│
└─────────────────┘
```

---

### Smart Contract Integration

```typescript
interface EscrowContract {
  // Customer initiates cancellation
  cancelBooking(
    bookingId: string
  ): Promise<TransactionReceipt>;

  // Or platform-mediated cancellation with refund split
  refundBooking(
    bookingId: string,
    customerRefundAmount: bigint,
    stylistCompensation: bigint
  ): Promise<TransactionReceipt>;
}
```

---

### Files to Create

| File | Purpose |
|------|---------|
| `apps/web/components/bookings/cancel-dialog.tsx` | Cancellation confirmation dialog |
| `apps/web/hooks/use-cancel-booking.ts` | Cancellation logic hook |

---

### Component: CancelBookingDialog

```tsx
interface CancelBookingDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  booking: {
    id: string;
    scheduledStartTime: string;
    service: { name: string; priceAmountCents: string };
    stylist: { displayName: string };
  };
  onSuccess: () => void;
}

type CancelState =
  | "idle"
  | "processing"
  | "confirming"
  | "success"
  | "error";
```

**Layout - Initial:**
```
+----------------------------------+
| Cancel Booking                   |
+----------------------------------+
|                                  |
| Are you sure you want to cancel  |
| your appointment with            |
| Sarah Johnson?                   |
|                                  |
+----------------------------------+
| Cancellation Policy              |
|                                  |
| ⚠ Cancelling 18 hours before     |
|   your appointment.              |
|                                  |
| You will receive a 75% refund.   |
|                                  |
+----------------------------------+
| Refund Summary                   |
|                                  |
| Original Amount      R385.00     |
| Refund (75%)         R288.75     |
| Stylist Fee           R96.25     |
+----------------------------------+
|                                  |
| [  Keep Booking  ]               |
| [  Cancel & Refund  ]            |
|                                  |
+----------------------------------+
```

**Layout - Processing:**
```
+----------------------------------+
| Cancelling Booking...            |
+----------------------------------+
|                                  |
| [Loading spinner]                |
|                                  |
| Processing your refund           |
|                                  |
+----------------------------------+
```

**Layout - Success:**
```
+----------------------------------+
| ✓ Booking Cancelled              |
+----------------------------------+
|                                  |
| Your refund of R288.75 has been  |
| returned to your wallet.         |
|                                  |
| Updated Balance: R788.75         |
|                                  |
+----------------------------------+
|                                  |
| [       Done       ]             |
|                                  |
+----------------------------------+
```

---

### Hook: useCancelBooking

```tsx
export function useCancelBooking() {
  const { writeContractAsync } = useWriteContract();
  const queryClient = useQueryClient();

  const cancelBooking = async (
    bookingId: string,
    refundPercentage: number
  ): Promise<void> => {
    // Calculate refund amount
    const booking = await getBooking(bookingId);
    const totalAmount = parseUnits(
      (parseInt(booking.service.priceAmountCents) / 100).toString(),
      6
    );
    const refundAmount = (totalAmount * BigInt(refundPercentage)) / 100n;

    // Call escrow contract
    const hash = await writeContractAsync({
      address: ESCROW_ADDRESS,
      abi: ESCROW_ABI,
      functionName: "cancelBooking",
      args: [bookingId],
    });

    // Wait for confirmation
    await waitForTransaction({ hash });

    // Update booking status via API
    await updateBookingStatus(bookingId, "CANCELLED");

    // Invalidate queries
    queryClient.invalidateQueries({ queryKey: ["bookings"] });
    queryClient.invalidateQueries({ queryKey: ["booking", bookingId] });
    queryClient.invalidateQueries({ queryKey: ["wallet"] });
  };

  return { cancelBooking };
}
```

---

### Refund Calculation

```typescript
function calculateRefund(
  totalAmountCents: number,
  refundPercentage: number
): {
  refundAmount: number;
  stylistFee: number;
} {
  const refundAmount = Math.round(totalAmountCents * (refundPercentage / 100));
  const stylistFee = totalAmountCents - refundAmount;

  return {
    refundAmount,
    stylistFee,
  };
}
```

---

### API Integration

```typescript
// Update booking status after successful escrow release
async function updateBookingStatus(
  bookingId: string,
  status: "CANCELLED"
): Promise<void> {
  await fetch(`/api/bookings/${bookingId}/cancel`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      status,
      cancelledAt: new Date().toISOString(),
      cancellationReason: "customer_requested",
    }),
  });
}
```

---

## UI/UX Requirements

### Visual Design
- Warning colors for cancellation dialog
- Clear refund breakdown table
- Prominent "Keep Booking" as primary action
- "Cancel & Refund" as secondary/destructive action
- Success state with wallet balance update

### States
- **Idle:** Dialog with policy and refund info
- **Processing:** Spinner, disabled buttons
- **Confirming:** Transaction being confirmed
- **Success:** Checkmark, refund details
- **Error:** Error message, retry option

### Cancel Button Visibility

```typescript
function canCancelBooking(booking: Booking): boolean {
  // Can only cancel CONFIRMED or PENDING_PAYMENT bookings
  if (!["CONFIRMED", "PENDING_PAYMENT"].includes(booking.status)) {
    return false;
  }

  // Cannot cancel past appointments
  if (new Date(booking.scheduledStartTime) < new Date()) {
    return false;
  }

  return true;
}
```

---

### Edge Cases

1. **No Refund Zone:** Clear message that proceeding means no refund
2. **Transaction Failure:** Show error, don't update booking status
3. **Network Error:** Retry option
4. **Already Cancelled:** Button hidden, status shown

---

### No Refund Warning

```tsx
{refundPercentage === 0 && (
  <div className="bg-destructive/10 border border-destructive rounded-lg p-4">
    <p className="text-destructive font-medium">⚠️ No Refund Available</p>
    <p className="text-sm text-text-secondary mt-1">
      You are cancelling less than 2 hours before your appointment.
      You will not receive a refund if you proceed.
    </p>
  </div>
)}
```

---

## Tasks Breakdown

| Task | Effort | Priority |
|------|--------|----------|
| Create `CancelBookingDialog` component | 45min | P0 |
| Create `useCancelBooking` hook | 30min | P0 |
| Implement cancellation policy logic | 20min | P0 |
| Implement refund calculation | 15min | P0 |
| Create refund summary UI | 20min | P1 |
| Add escrow contract interaction | 30min | P0 |
| Create success state UI | 20min | P1 |
| Add error handling | 20min | P1 |
| Connect cancel button in BookingDetails | 15min | P0 |
| Add loading states | 15min | P1 |

**Total Estimated Time:** ~4 hours

---

## Verification Checklist

- [ ] Cancel button visible on CONFIRMED bookings
- [ ] Cancel button hidden on COMPLETED/CANCELLED
- [ ] Cancel button hidden on past appointments
- [ ] Dialog shows cancellation policy
- [ ] Correct refund percentage based on time
- [ ] Refund amount calculated correctly
- [ ] "Keep Booking" closes dialog
- [ ] "Cancel & Refund" initiates cancellation
- [ ] Escrow contract called correctly
- [ ] Transaction confirmation waited
- [ ] Booking status updated to CANCELLED
- [ ] Success screen shows refund amount
- [ ] Wallet balance refreshed
- [ ] Error handling works
- [ ] No refund warning displayed when applicable
- [ ] Cannot cancel twice
- [ ] Bookings list refreshed after cancellation

---

## Future Enhancements

- Stylist-initiated cancellation (full refund)
- Dispute flow for partial services
- Reschedule instead of cancel
- Cancellation reason selection
- Automatic refund for stylist no-show
