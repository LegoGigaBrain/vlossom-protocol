# F2.6: Booking Summary & Payment Preview

## Feature Specification

**Feature ID:** F2.6
**Feature Name:** Booking Summary & Payment Preview
**Milestone:** 2 - Customer Can Book
**Priority:** High
**Status:** Planned
**Depends On:** F2.5

---

## User Story

> As a customer, I want to review all booking details and see the total cost before confirming so that I can ensure everything is correct.

---

## Acceptance Criteria

1. Display selected stylist, service, date/time, location
2. Show full price breakdown (service + fees)
3. Show wallet balance and payment status
4. Allow editing each section (return to that step)
5. "Confirm & Pay" creates booking and proceeds to payment
6. Insufficient balance shows "Add Money" option

---

## Technical Specification

### Price Breakdown

```typescript
interface PriceBreakdown {
  serviceAmount: number;     // Service base price (cents)
  travelFee: number;         // Travel fee if applicable (cents)
  platformFee: number;       // Platform fee (10% of service)
  totalAmount: number;       // Grand total (cents)
}

function calculatePriceBreakdown(servicePriceCents: number, hasTravelFee: boolean): PriceBreakdown {
  const serviceAmount = servicePriceCents;
  const travelFee = hasTravelFee ? 5000 : 0; // R50 flat fee for MVP
  const platformFee = Math.round(serviceAmount * 0.10); // 10%
  const totalAmount = serviceAmount + travelFee; // Platform fee included in service

  return { serviceAmount, travelFee, platformFee, totalAmount };
}
```

### Wallet Balance Check

```typescript
// From existing wallet hook
const { data: wallet } = useWallet();
const hasBalance = wallet && wallet.balance.usdcFormatted >= requiredAmount;
```

---

### Files to Create

| File | Purpose |
|------|---------|
| `apps/web/components/booking/booking-summary.tsx` | Summary step component |

---

### Component: BookingSummary

```tsx
interface BookingSummaryProps {
  booking: {
    stylist: Stylist;
    service: Service;
    scheduledTime: Date;
    location: LocationSelection;
    notes: string;
  };
  priceBreakdown: PriceBreakdown;
  walletBalance: number;
  onEdit: (step: BookingStep) => void;
  onConfirm: () => void;
  onBack: () => void;
  onAddMoney: () => void;
}
```

**Layout:**
```
+----------------------------------+
| [<] Back                         |
| Review Your Booking              |
+----------------------------------+
| Stylist                    [Edit]|
| Sarah Johnson                    |
| ✓ Verified Stylist               |
+----------------------------------+
| Service                    [Edit]|
| Box Braids                       |
| Duration: 2h 30min               |
+----------------------------------+
| Date & Time                [Edit]|
| Mon, 15 Jan 2025                 |
| 10:00 AM                         |
+----------------------------------+
| Location                   [Edit]|
| Stylist's Location               |
| 123 Main St, Cape Town           |
+----------------------------------+
| Notes (optional)           [Edit]|
| Please use gentle products       |
+----------------------------------+
|                                  |
| Price Breakdown                  |
| ─────────────────────────────    |
| Box Braids             R350.00   |
| Platform Fee            R35.00   |
| ─────────────────────────────    |
| Total                  R385.00   |
|                                  |
+----------------------------------+
| Wallet Balance: R500.00 ✓        |
| or                               |
| Wallet Balance: R100.00 ⚠        |
| [Add Money]                      |
+----------------------------------+
| [     Confirm & Pay     ]        |
+----------------------------------+
```

---

### Edit Flow

```tsx
const handleEdit = (step: BookingStep) => {
  // Navigate back to specific step
  setStep(step);
  // State preserved, user can modify and return
};
```

---

### Insufficient Balance State

```tsx
{!hasBalance && (
  <div className="bg-accent/10 border border-accent rounded-lg p-4">
    <p className="text-accent font-medium">Insufficient Balance</p>
    <p className="text-sm text-text-secondary mt-1">
      You need R{formatPrice(totalAmount - walletBalance)} more to complete this booking.
    </p>
    <Button
      variant="outline"
      className="mt-3"
      onClick={onAddMoney}
    >
      Add Money
    </Button>
  </div>
)}
```

---

## UI/UX Requirements

### Visual Design
- Clean section cards with edit buttons
- Price breakdown in table format
- Total emphasized (larger font)
- Wallet status with icon (✓ or ⚠)
- Primary CTA: "Confirm & Pay"

### States
- **Sufficient balance:** Green checkmark, CTA enabled
- **Insufficient balance:** Warning, CTA disabled, Add Money shown
- **Loading:** CTA shows loading spinner

### Interactions
- Edit buttons: Return to that step (state preserved)
- Add Money: Opens add money dialog
- Confirm & Pay: Creates booking, proceeds to payment step

---

## Creating Booking

On "Confirm & Pay" click:

```typescript
const handleConfirm = async () => {
  setLoading(true);
  try {
    // Create booking via API
    const booking = await createBooking({
      customerId: user.id,
      stylistId: state.stylist.id,
      serviceId: state.service.id,
      scheduledStartTime: state.scheduledTime.toISOString(),
      locationType: state.location.type,
      locationAddress: state.location.address,
      locationLat: state.location.lat,
      locationLng: state.location.lng,
      notes: state.notes,
    });

    // Store booking ID for payment step
    setBookingId(booking.id);
    setStep("payment");
  } catch (error) {
    setError(error.message);
  } finally {
    setLoading(false);
  }
};
```

---

## Tasks Breakdown

| Task | Effort | Priority |
|------|--------|----------|
| Create `BookingSummary` component | 45min | P0 |
| Create summary sections (stylist/service/etc) | 30min | P0 |
| Implement price breakdown calculation | 20min | P0 |
| Add wallet balance check | 15min | P0 |
| Create insufficient balance state | 20min | P1 |
| Implement edit navigation | 20min | P1 |
| Add notes input | 15min | P2 |
| Connect to booking API | 20min | P0 |
| Add loading states | 15min | P1 |

**Total Estimated Time:** ~3.5 hours

---

## Verification Checklist

- [ ] All booking details display correctly
- [ ] Stylist info shown with verification status
- [ ] Service name, duration displayed
- [ ] Date/time formatted correctly
- [ ] Location displayed correctly
- [ ] Notes section works (optional)
- [ ] Price breakdown calculates correctly
- [ ] Platform fee calculated (10%)
- [ ] Total amount correct
- [ ] Wallet balance displayed
- [ ] Sufficient balance shows green check
- [ ] Insufficient balance shows warning
- [ ] Add Money button works
- [ ] Edit buttons navigate to correct steps
- [ ] Confirm creates booking
- [ ] Loading state displays
- [ ] Error handling works
- [ ] Navigates to payment step on success
